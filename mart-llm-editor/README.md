# マート改修AIツール

Google Gemini APIを使用して、データウェアハウスのマート（SQLファイル）を自動改修するツールです。

## 概要

このツールは、自然言語による改修要望を受け取り、以下の処理を自動で実行します：

1. **マートルーター**: `meta_data.json`を参照し、改修対象のSQLファイルを1つ選択
2. **マート改修プランナー**: 改修案（Markdown）を作成し、ユーザー確認を行う
3. **マートエディター**: 同意後にSQLを自動改修し、ファイルへ上書き

## セットアップ

### 1. 仮想環境の作成と有効化

```bash
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate  # Windows
```

### 2. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

### 3. 環境変数の設定

Google Gemini APIキーを環境変数に設定します：

```bash
export GOOGLE_API_KEY="あなたのAPIキー"
```

または、`.env`ファイルを作成して設定することもできます（その場合は`python-dotenv`の追加が必要です）。

## 使用方法

1. 仮想環境を有効化します
2. 環境変数`GOOGLE_API_KEY`が設定されていることを確認します
3. `main.py`を実行します：

```bash
python main.py
```

4. プロンプトが表示されたら、マート改修要望を日本語で入力します

例：
```
売上マートに粗利列を追加したい
```

5. 以降の対話フロー
   - ルーター: 改修対象マートを1つ選択
   - プランナー: 改修プラン(MD)を表示
   - ユーザー入力:
     - 実装OKなら `OK` / `進めて` / `大丈夫` / `はい` / `実装して` のいずれか
     - それ以外の入力は追加要望として元リクエストにマージし、プランを再生成
   - 同意後: エディターがSQLを改修し、対象ファイルを上書き
   - `q`/`quit`/`exit` で終了

## プロジェクト構造

```
demo/
├── main.py                          # メインスクリプト
├── meta_data.json                   # マートメタデータ（path, description）
├── requirements.txt                 # 依存パッケージ
├── prompts/
│   ├── mart_router_system_prompt.md # マートルーター用プロンプト
│   ├── mart_edit_planner_system_prompt.md # マート改修プランナー用プロンプト
│   └── mart_editor_system_prompt.md # マートエディター用プロンプト
└── sql/
    ├── revenue.sql                  # 売上マートSQL
    ├── office.sql                   # オフィスマスタSQL
    └── cost.sql                     # コストマートSQL
```

## マートメタデータの管理

`meta_data.json`にマート情報を登録することで、新しいマートも自動的に認識されます。

```json
[
  {
    "path": "sql/revenue.sql",
    "description": "売上情報を集計したファクトテーブル..."
  }
]
```

## 注意事項

- このツールは既存のマートを改修することを想定しています
- 新規マートの作成には対応していません
- SQLファイルは同意後に自動で上書きされます。実行前にバックアップを推奨します
- プラン確認時に追加要望を入力すると元リクエストへ追記され、プランが再生成されます
- 改修内容は必ずレビューしてから本番環境に適用してください

## トラブルシューティング

### JSON解析エラーが発生する場合

Gemini APIのレスポンスにマークダウンのコードブロックが含まれている場合、自動的に抽出します。エラー時はレスポンス内容が表示されるので確認してください。

### ファイルが見つからない場合

`meta_data.json`の`path`が正しいことを確認してください。パスは`main.py`からの相対パスで指定します。

## ライセンス

個人学習用です
